name: Build and Publish ReVanced CLI

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: false
        type: string

concurrency:
  group: build-${{ github.event.release.tag_name || github.run_id }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      packages: write
    
    env:
      GITHUB_ACTOR: ${{ github.actor }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Extract version from tag
      id: version
      run: |
        if [ "${{ github.event_name }}" == "release" ]; then
          TAG="${{ github.event.release.tag_name }}"
        elif [ -n "${{ inputs.version }}" ]; then
          TAG="${{ inputs.version }}"
        else
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "dev")
        fi
        
        VERSION="${TAG#[vV]}"
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        echo "=================================="
        echo "Release Tag: $TAG"
        echo "Clean Version: $VERSION"
        echo "JAR will be: revanced-cli-$VERSION.jar"
        echo "=================================="

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582

    - name: Clean build
      run: |
        echo "üßπ Cleaning..."
        rm -rf build/
        ./gradlew clean --no-daemon

    - name: Build with Gradle
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        echo "üî® Building version: $VERSION"
        ./gradlew build shadowJar --no-daemon --stacktrace
        
        echo ""
        echo "üì¶ Built artifacts:"
        ls -lh build/libs/

    - name: Find built JAR
      id: jar
      run: |
        JAR_FILE=$(find build/libs -name "revanced-cli-*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -1)
        
        if [ -z "$JAR_FILE" ]; then
          echo "‚ùå JAR not found!"
          exit 1
        fi
        
        echo "jar_file=$JAR_FILE" >> $GITHUB_OUTPUT
        echo "jar_name=$(basename $JAR_FILE)" >> $GITHUB_OUTPUT
        echo "‚úÖ Built: $(basename $JAR_FILE)"

    - name: Publish to GitHub Packages
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: |
        echo "üì§ Publishing to GitHub Packages..."
        ./gradlew publish --no-daemon
        echo "‚úÖ Published"

    - name: Generate checksums
      run: |
        cd build/libs
        echo "üîê Generating checksums..."
        for jar in revanced-cli-*.jar; do
          if [ -f "$jar" ]; then
            sha256sum "$jar" > "$jar.sha256"
            echo "Generated: $jar.sha256"
          fi
        done
        sha256sum revanced-cli-*.jar > checksums.txt 2>/dev/null || true
        
        echo ""
        echo "Checksums:"
        cat checksums.txt

    - name: Upload to Release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          build/libs/revanced-cli-*.jar
          build/libs/*.sha256
          build/libs/checksums.txt
        tag_name: ${{ github.event.release.tag_name }}
        fail_on_unmatched_files: false

    - name: Upload artifacts (manual runs)
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: revanced-cli-${{ steps.version.outputs.version }}
        path: |
          build/libs/revanced-cli-*.jar
          build/libs/*.sha256
          build/libs/checksums.txt
        retention-days: 30

    - name: Build Summary
      if: success()
      run: |
        echo "## ‚úÖ Build Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** \`${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Artifact:** \`${{ steps.jar.outputs.jar_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Files" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        ls -lh build/libs/*.jar build/libs/*.sha256 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        ./gradlew --stop || true
        rm -rf ~/.gradle/daemon/

  cleanup-on-failure:
    runs-on: ubuntu-latest
    needs: build
    if: failure() && github.event_name == 'release'
    permissions:
      contents: write
    steps:
    - name: Delete failed release
      run: |
        echo "‚ùå Build failed - deleting release"
        gh release delete "${{ github.event.release.tag_name }}" --yes --cleanup-tag
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_REPO: ${{ github.repository }}
